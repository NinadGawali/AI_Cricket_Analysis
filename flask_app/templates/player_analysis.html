{% extends "base.html" %}

{% block content %}
<div class="analytics-container">
    <header class="page-header">
        <h1>Advanced Player Analysis</h1>
        <p>Deep dive into player performance across ODI, T20 International, Test, and IPL cricket.</p>
    </header>

    <!-- Format Selector -->
    <div class="format-selector">
        <label>Select Format:</label>
        <select id="format-select" onchange="updateFormat()">
            <option value="all">All Formats</option>
            <option value="odi">ODI</option>
            <option value="t20">T20 International</option>
            <option value="test">Test</option>
            <option value="ipl">IPL</option>
        </select>
    </div>

    <div class="analysis-tabs">
        <button class="tab-btn active" onclick="openTab(event, 'comparison')">Player Comparison</button>
        <button class="tab-btn" onclick="openTab(event, 'h2h')">Batter vs Bowler</button>
        <button class="tab-btn" onclick="openTab(event, 'exploration')">Player Exploration</button>
    </div>

    <!-- Tab 1: Player Comparison -->
    <div id="comparison" class="tab-content" style="display: block;">
        <div class="input-group">
            <input type="text" id="p1-input" placeholder="Player 1 Name (e.g. Virat Kohli)" list="player-list-1">
            <datalist id="player-list-1"></datalist>
            <input type="text" id="p2-input" placeholder="Player 2 Name (e.g. Rohit Sharma)" list="player-list-2">
            <datalist id="player-list-2"></datalist>
            <button class="btn btn-primary" onclick="comparePlayers()">Compare</button>
        </div>
        <div id="comparison-results" class="results-area"></div>
    </div>

    <!-- Tab 2: Batter vs Bowler -->
    <div id="h2h" class="tab-content">
        <div class="input-group">
            <input type="text" id="batter-input" placeholder="Batter Name (e.g. MS Dhoni)" list="batter-list">
            <datalist id="batter-list"></datalist>
            <input type="text" id="bowler-input" placeholder="Bowler Name (e.g. Jasprit Bumrah)" list="bowler-list">
            <datalist id="bowler-list"></datalist>
            <button class="btn btn-primary" onclick="analyzeH2H()">Analyze Head-to-Head</button>
        </div>
        <div id="h2h-results" class="results-area"></div>
    </div>

    <!-- Tab 3: Player Exploration -->
    <div id="exploration" class="tab-content">
        <div class="input-group">
            <input type="text" id="explore-player-input" placeholder="Player Name" list="explore-list">
            <datalist id="explore-list"></datalist>
            <select id="explore-type">
                <option value="venue">Venue Stats</option>
                <option value="spin_pace">Spin vs Pace Analysis</option>
            </select>
            <button class="btn btn-primary" onclick="explorePlayer()">Explore</button>
        </div>
        <div id="exploration-results" class="results-area"></div>
    </div>
</div>

<script>
let currentFormat = 'all';

function updateFormat() {
    currentFormat = document.getElementById('format-select').value;
}

function openTab(evt, tabName) {
    var i, tabcontent, tablinks;
    tabcontent = document.getElementsByClassName("tab-content");
    for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
    }
    tablinks = document.getElementsByClassName("tab-btn");
    for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
    }
    document.getElementById(tabName).style.display = "block";
    evt.currentTarget.className += " active";
}

// Player autocomplete
async function setupAutocomplete(inputId, listId) {
    const input = document.getElementById(inputId);
    const list = document.getElementById(listId);
    
    input.addEventListener('input', async function() {
        if (input.value.length < 2) return;
        
        try {
            const response = await fetch(`/api/players?search=${input.value}&format=${currentFormat}`);
            const players = await response.json();
            
            list.innerHTML = '';
            players.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                list.appendChild(option);
            });
        } catch (e) {
            console.error('Autocomplete error:', e);
        }
    });
}

// Setup autocomplete for all inputs
document.addEventListener('DOMContentLoaded', function() {
    setupAutocomplete('p1-input', 'player-list-1');
    setupAutocomplete('p2-input', 'player-list-2');
    setupAutocomplete('batter-input', 'batter-list');
    setupAutocomplete('bowler-input', 'bowler-list');
    setupAutocomplete('explore-player-input', 'explore-list');
});

async function comparePlayers() {
    const p1 = document.getElementById('p1-input').value;
    const p2 = document.getElementById('p2-input').value;
    const resultsDiv = document.getElementById('comparison-results');
    
    if (!p1 || !p2) {
        resultsDiv.innerHTML = '<p class="error">Please enter both player names</p>';
        return;
    }
    
    resultsDiv.innerHTML = '<div class="loader"></div>';
    
    try {
        const response = await fetch(`/api/player-comparison?p1=${encodeURIComponent(p1)}&p2=${encodeURIComponent(p2)}&format=${currentFormat}`);
        const data = await response.json();
        
        if (data.error) {
            resultsDiv.innerHTML = `<p class="error">${data.error}</p>`;
            return;
        }
        
        if (!data.batting || data.batting.length === 0) {
            resultsDiv.innerHTML = `<p>No data found for these players</p>`;
            return;
        }
        
        let html = '<h3>Batting Comparison</h3>';
        html += '<table><tr><th>Format</th><th>Player</th><th>Runs</th><th>Matches</th><th>Balls</th><th>Strike Rate</th></tr>';
        data.batting.forEach(p => {
            html += `<tr>
                <td>${p.format || '-'}</td>
                <td><strong>${p.player}</strong></td>
                <td>${p.runs || 0}</td>
                <td>${p.matches || 0}</td>
                <td>${p.balls || 0}</td>
                <td>${p.strike_rate || 0}</td>
            </tr>`;
        });
        html += '</table>';
        
        if (data.bowling && data.bowling.length > 0) {
            html += '<h3>Bowling Comparison</h3>';
            html += '<table><tr><th>Format</th><th>Player</th><th>Balls</th><th>Runs</th><th>Wickets</th><th>Economy</th></tr>';
            data.bowling.forEach(p => {
                html += `<tr>
                    <td>${p.format || '-'}</td>
                    <td><strong>${p.player}</strong></td>
                    <td>${p.balls || 0}</td>
                    <td>${p.runs_conceded || 0}</td>
                    <td>${p.wickets || 0}</td>
                    <td>${p.economy || 0}</td>
                </tr>`;
            });
            html += '</table>';
        }
        
        resultsDiv.innerHTML = html;
    } catch (e) {
        resultsDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
    }
}

async function analyzeH2H() {
    const batter = document.getElementById('batter-input').value;
    const bowler = document.getElementById('bowler-input').value;
    const resultsDiv = document.getElementById('h2h-results');
    
    if (!batter || !bowler) {
        resultsDiv.innerHTML = '<p class="error">Please enter both batter and bowler names</p>';
        return;
    }
    
    resultsDiv.innerHTML = '<div class="loader"></div>';
    
    try {
        const response = await fetch(`/api/batter-vs-bowler?batter=${encodeURIComponent(batter)}&bowler=${encodeURIComponent(bowler)}&format=${currentFormat}`);
        const data = await response.json();
        
        if (data.error) {
            resultsDiv.innerHTML = `<p class="error">${data.error}</p>`;
            return;
        }
        
        if (!data.balls_faced || data.balls_faced === 0) {
            resultsDiv.innerHTML = `<p>No head-to-head data found for ${batter} vs ${bowler}</p>`;
            return;
        }
        
        const sr = data.balls_faced > 0 ? ((data.runs_scored / data.balls_faced) * 100).toFixed(2) : 0;
        
        let html = `
            <div class="h2h-summary">
                <h3>${batter} vs ${bowler}</h3>
                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-value">${data.runs_scored}</span>
                        <span class="stat-label">Runs</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value">${data.balls_faced}</span>
                        <span class="stat-label">Balls</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value">${data.dismissals}</span>
                        <span class="stat-label">Dismissals</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value">${sr}</span>
                        <span class="stat-label">Strike Rate</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value">${data.fours}</span>
                        <span class="stat-label">Fours</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-value">${data.sixes}</span>
                        <span class="stat-label">Sixes</span>
                    </div>
                </div>
            </div>
        `;
        
        if (data.by_format && data.by_format.length > 0) {
            html += '<h4>Breakdown by Format</h4>';
            html += '<table><tr><th>Format</th><th>Balls</th><th>Runs</th><th>Dismissals</th><th>4s</th><th>6s</th></tr>';
            data.by_format.forEach(f => {
                if (f.balls_faced > 0) {
                    html += `<tr>
                        <td>${f.format}</td>
                        <td>${f.balls_faced}</td>
                        <td>${f.runs_scored}</td>
                        <td>${f.dismissals}</td>
                        <td>${f.fours}</td>
                        <td>${f.sixes}</td>
                    </tr>`;
                }
            });
            html += '</table>';
        }
        
        resultsDiv.innerHTML = html;
    } catch (e) {
        resultsDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
    }
}

async function explorePlayer() {
    const player = document.getElementById('explore-player-input').value;
    const type = document.getElementById('explore-type').value;
    const resultsDiv = document.getElementById('exploration-results');
    
    if (!player) {
        resultsDiv.innerHTML = '<p class="error">Please enter a player name</p>';
        return;
    }
    
    resultsDiv.innerHTML = '<div class="loader"></div>';
    
    try {
        if (type === 'venue') {
            const response = await fetch(`/api/player-venue?player=${encodeURIComponent(player)}&format=${currentFormat}`);
            const data = await response.json();
            
            if (data.error) {
                resultsDiv.innerHTML = `<p class="error">${data.error}</p>`;
                return;
            }
            
            if (!data || data.length === 0) {
                resultsDiv.innerHTML = `<p>No venue data found for ${player}</p>`;
                return;
            }
            
            let html = `<h3>${player} - Venue Performance</h3>`;
            html += '<table><tr><th>Venue</th><th>Runs</th><th>Balls</th><th>Matches</th><th>Strike Rate</th></tr>';
            data.forEach(row => {
                html += `<tr>
                    <td>${row.venue}</td>
                    <td>${row.runs}</td>
                    <td>${row.balls}</td>
                    <td>${row.matches}</td>
                    <td>${row.strike_rate}</td>
                </tr>`;
            });
            html += '</table>';
            resultsDiv.innerHTML = html;
            
        } else if (type === 'spin_pace') {
            resultsDiv.innerHTML = '<div class="loader"></div><p style="text-align:center">Analyzing bowler types with AI... This may take a moment.</p>';
            const response = await fetch(`/api/player-spin-pace?player=${encodeURIComponent(player)}&format=${currentFormat}`);
            const data = await response.json();
            
            if (data.error) {
                resultsDiv.innerHTML = `<p class="error">${data.error}</p>`;
                return;
            }
            
            resultsDiv.innerHTML = `
                <h3>${player} - Performance vs Spin & Pace</h3>
                <div class="comparison-grid">
                    <div class="stat-card spin-card">
                        <h4>Vs Spin</h4>
                        <div class="big-stat">${data.spin.runs}</div>
                        <div class="stat-label">Runs</div>
                        <p>Balls: ${data.spin.balls}</p>
                        <p>Strike Rate: <strong>${data.spin.avg_sr}</strong></p>
                    </div>
                    <div class="stat-card pace-card">
                        <h4>Vs Pace</h4>
                        <div class="big-stat">${data.pace.runs}</div>
                        <div class="stat-label">Runs</div>
                        <p>Balls: ${data.pace.balls}</p>
                        <p>Strike Rate: <strong>${data.pace.avg_sr}</strong></p>
                    </div>
                </div>
                <div class="analysis-note">
                    <small>* Bowler classification performed using AI based on known bowling styles</small>
                </div>
            `;
        }
    } catch (e) {
        resultsDiv.innerHTML = `<p class="error">Error: ${e.message}</p>`;
    }
}
</script>

<style>
.page-header {
    text-align: center;
    margin-bottom: 2rem;
}

.page-header h1 {
    color: #1565C0;
    margin-bottom: 0.5rem;
}

.format-selector {
    text-align: center;
    margin-bottom: 1.5rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.format-selector label {
    font-weight: 600;
    margin-right: 0.5rem;
}

.format-selector select {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: 2px solid #1565C0;
    font-size: 1rem;
    cursor: pointer;
}

.analysis-tabs {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
    justify-content: center;
}

.tab-btn {
    padding: 12px 24px;
    border: none;
    background: #e0e0e0;
    cursor: pointer;
    border-radius: 8px;
    font-weight: 600;
    transition: all 0.3s;
}

.tab-btn.active {
    background: #1565C0;
    color: white;
}

.tab-btn:hover {
    background: #1976D2;
    color: white;
}

.tab-content {
    display: none;
    padding: 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}

.input-group {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.input-group input, .input-group select {
    padding: 12px 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    flex: 1;
    min-width: 180px;
    font-size: 1rem;
}

.input-group input:focus, .input-group select:focus {
    border-color: #1565C0;
    outline: none;
}

.btn-primary {
    background: #1565C0;
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
}

.btn-primary:hover {
    background: #0D47A1;
}

.results-area {
    min-height: 200px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

th, td {
    border: 1px solid #e0e0e0;
    padding: 12px;
    text-align: left;
}

th {
    background: #1565C0;
    color: white;
}

tr:nth-child(even) {
    background: #f8f9fa;
}

tr:hover {
    background: #e3f2fd;
}

.h2h-summary {
    text-align: center;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 15px;
    margin: 20px 0;
}

.stat-box {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.stat-box .stat-value {
    display: block;
    font-size: 2rem;
    font-weight: bold;
    color: #1565C0;
}

.stat-box .stat-label {
    color: #666;
    font-size: 0.9rem;
}

.comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    padding: 25px;
    border-radius: 12px;
    text-align: center;
}

.spin-card {
    background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    border: 2px solid #1976D2;
}

.pace-card {
    background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
    border: 2px solid #c2185b;
}

.stat-card h4 {
    margin: 0 0 15px;
    color: #333;
}

.big-stat {
    font-size: 3rem;
    font-weight: bold;
    color: #1565C0;
}

.analysis-note {
    text-align: center;
    margin-top: 20px;
    color: #666;
}

.loader {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #1565C0;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 30px auto;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.error {
    color: #d32f2f;
    background: #ffebee;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
}
</style>
{% endblock %}
